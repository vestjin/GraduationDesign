<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Linux C Cloud Disk Pro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 950px; margin: 20px auto; background-color: #f4f6f9; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input, button { padding: 8px 12px; margin: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; outline: none; transition: border 0.2s; }
        input:focus { border-color: #2196F3; }
        button { cursor: pointer; border: none; color: white; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); box-shadow: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 4px; overflow: hidden; }
        th, td { border-bottom:1px solid #eee; padding: 12px; text-align: left; }
        th { background-color: #333; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f0f7ff; }
        .folder { color: #FF9800; font-weight: bold; cursor: pointer; }
        .status { color: #4CAF50; font-size: 0.9em; }
        h2 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; color: #333; }
        
        /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
        .upload-section { margin-top: 20px; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .progress-container { background: #e0e0e0; height: 18px; width: 100%; border-radius: 9px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); transition: width 0.2s; text-align: center; color: white; font-size: 11px; line-height: 18px; font-weight: bold; }
        .btn-action { cursor: pointer; padding:4px 10px; font-size: 12px; border-radius: 3px; border: none; color: white; width: 65px; box-shadow: none; margin-right: 5px;}
        .btn-pause { background: #FF9800; }
        .btn-resume { background: #2196F3; }
        .btn-delete { background: #f44336; }
        .btn-retry { background: #607D8B; }
        .task-table th { background-color: #555; font-size: 13px; padding: 8px; }
        .task-table td { padding: 8px; font-size: 12px; vertical-align: middle; }
        .op-btn { margin-right: 5px; font-size: 12px; padding: 5px 10px; }

        /* ç§»åŠ¨æ–‡ä»¶ æ¨¡æ€æ¡†æ ·å¼ (ç®€å•ä¸‹æ‹‰é€‰æ‹©ç‰ˆ) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; /* æé«˜ z-index */
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 8px; width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom:1px solid #eee; padding-bottom: 10px; }
        .modal-title { font-size: 18px; font-weight: bold; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; box-shadow: none; line-height: 1;}
        .close-btn:hover { color: #333; box-shadow: none; }

        /* ä¸‹æ‹‰é€‰æ‹©æ¡†æ ·å¼ */
        select { 
            width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; 
            background-color: white; outline: none; margin-bottom: 20px;
        }

        /* =========================================================== */
        /* ã€ä¿®å¤å…³é”®ã€‘å°† .hidden æ”¾åˆ°æœ€åï¼Œå¹¶åŠ  !important ç¡®ä¿ç”Ÿæ•ˆ */
        .hidden { display: none !important; }
        /* =========================================================== */
    </style>
    <!-- å¼•å…¥ SparkMD5 ç”¨äºè®¡ç®—ç§’ä¼  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-view" class="hidden" style="max-width: 400px; margin: 80px auto; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;">
        <h2 style="border:none; margin-bottom: 30px; color: #333;">ç½‘ç›˜ç³»ç»Ÿ</h2>
        <div style="margin-bottom: 20px;">
            <input type="text" id="login-user" placeholder="ç”¨æˆ·å" style="width: 90%; display: block; margin: 0 auto;">
        </div>
        <div style="margin-bottom: 30px;">
            <input type="password" id="login-pass" placeholder="å¯†ç " style="width: 90%; display: block; margin: 0 auto;">
        </div>
        <div>
            <button onclick="doLogin()" style="width: 45%; background-color: #2196F3;">ç™»å½•</button>
            <button onclick="doRegister()" style="width: 45%; background-color: #4CAF50;">æ³¨å†Œ</button>
        </div>
        <p id="login-msg" class="status" style="text-align: center; margin-top: 20px; color: #f44336;"></p>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-view" class="hidden">
        <h2>æˆ‘çš„äº‘ç›˜</h2>
        
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div style="background: white; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="font-weight: 500; color: #333;">
                <span>å½“å‰è·¯å¾„: </span>
                <span id="current-path" style="color: #2196F3; font-weight: bold;">Root</span>
            </div>
            <div>
                <button onclick="doLogout()" style="background-color: #f44336; font-size: 13px;">é€€å‡º</button>
                <button onclick="goBack()" style="background-color: #607D8B; font-size: 13px;">è¿”å›ä¸Šçº§</button>
            </div>
        </div>
        
        <!-- æ“ä½œåŒº -->
        <div class="upload-section">
            <div style="margin-bottom: 15px;">
                <input type="text" id="new-folder-name" placeholder="æ–°å»ºæ–‡ä»¶å¤¹åç§°" style="width: 65%;">
                <button onclick="doMkdir()" style="background-color: #009688;">æ–°å»ºæ–‡ä»¶å¤¹</button>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div style="display: flex; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                <input type="file" id="file-input" multiple onchange="handleFileSelect(event)" style="border: 1px solid #ddd;">
                <span style="margin-left: 15px; font-size: 13px; color: #666;">æç¤ºï¼šæ”¯æŒå¤šé€‰å¹¶å‘ä¸Šä¼ </span>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <h4 style="margin-top: 20px; margin-bottom: 10px; border-left: 4px solid #2196F3; padding-left: 10px;">ä¸Šä¼ ä»»åŠ¡åˆ—è¡¨</h4>
            <table id="upload-task-list" class="task-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">æ–‡ä»¶å</th>
                        <th style="width: 10%;">å¤§å°</th>
                        <th style="width: 35%;">è¿›åº¦</th>
                        <th style="width: 10%;">çŠ¶æ€</th>
                        <th style="width: 15%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="upload-tbody">
                    <!-- åŠ¨æ€ç”Ÿæˆä»»åŠ¡ -->
                </tbody>
            </table>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <h3 style="margin-top: 30px; border-left: 4px solid #4CAF50; padding-left: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">æ–‡ä»¶æµè§ˆ</h3>
        <table id="file-list">
            <thead>
                <tr>
                    <th>åç§° (æ‚¬åœæŸ¥çœ‹ID)</th>
                    <th>å¤§å°</th>
                    <th>ç±»å‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="file-tbody">
                <!-- æ–‡ä»¶åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
    </div>

    <!-- ç§»åŠ¨æ–‡ä»¶ æ¨¡æ€æ¡† (ç®€å•ä¸‹æ‹‰é€‰æ‹©ç‰ˆ) -->
    <div id="move-modal" class="hidden modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹</span>
                <button class="close-btn" onclick="closeMoveModal()">Ã—</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <p style="font-size: 13px; color: #666; margin-top: 0;">è¯·åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ç›®æ ‡ä½ç½®ï¼š</p>
                <select id="move-folder-select">
                    <option value="0" selected>ğŸ“‚ æ ¹ç›®å½•</option>
                    <!-- JS ä¼šåŠ¨æ€å¡«å……å…¶ä»–æ–‡ä»¶å¤¹åˆ°è¿™é‡Œ -->
                </select>
            </div>

            <div style="text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
                <button onclick="closeMoveModal()" style="background-color: #999;">å–æ¶ˆ</button>
                <button onclick="confirmMove()" style="background-color: #2196F3;">ç¡®è®¤ç§»åŠ¨</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const CHUNK_SIZE =5 * 1024 * 1024; // 5MB åˆ†ç‰‡
        const API_BASE = 'http://127.0.0.1:8080';
        let token = localStorage.getItem('token');
        let currentParentId = 0;
        let pathStack = [{id: 0, name: 'Root'}];
        let fileToMoveId = null;

        // ---------------------------------------------------------
        // ä»»åŠ¡ç®¡ç†å™¨æ ¸å¿ƒç±»
        // ---------------------------------------------------------
        class UploadTask {
            constructor(file, onComplete, onError) {
                this.file = file;
                this.status = 'PENDING'; 
                this.progress = 0; 
                this.offset = 0;
                this.md5 = null;
                this.controller = null; 
                this.onComplete = onComplete;
                this.onError = onError;
                this.fileSafeId = file.name.replace(/\W/g,'_'); 
            }

            async start() {
                if (this.status === 'UPLOADING' || this.status === 'FINISHED') return;
                
                this.status = 'UPLOADING';
                this.controller = new AbortController();
                this.updateUI();

                try {
                    this.md5 = await this.calcMD5();
                    const checkRes = await this.checkUpload(this.md5);
                    
                    if (checkRes.status === 'instant') {
                        this.finish();
                        return;
                    }

                    this.offset = checkRes.offset || 0;
                    const totalSize = this.file.size;

                    while (this.offset < totalSize && this.status === 'UPLOADING') {
                        const end = Math.min(this.offset + CHUNK_SIZE, totalSize);
                        const chunk = this.file.slice(this.offset, end);
                        await this.uploadChunk(this.md5, this.offset, chunk);
                        this.offset = end;
                        this.progress = Math.floor((this.offset / totalSize) * 100);
                        this.updateUI();
                    }

                    if (this.status === 'UPLOADING') {
                        await this.completeUpload(this.md5);
                        this.finish();
                    }

                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.status = 'PAUSED'; 
                    } else {
                        console.error(error);
                        this.status = 'ERROR';
                        this.onError(this);
                    }
                    this.updateUI();
                }
            }

            pause() {
                if (this.status === 'UPLOADING' && this.controller) {
                    this.controller.abort();
                    this.status = 'PAUSED';
                    this.updateUI();
                }
            }

            async calcMD5() {
                return new Promise((resolve) => {
                    const spark = new SparkMD5.ArrayBuffer();
                    const reader = new FileReader();
                    let currentChunk = 0;
                    const readChunkSize = 2 * 1024 * 1024; 
                    const chunks = Math.ceil(this.file.size / readChunkSize);
                    
                    const loadNext = () => {
                        const start = currentChunk * readChunkSize;
                        const end = Math.min(start + readChunkSize, this.file.size);
                        reader.readAsArrayBuffer(this.file.slice(start, end));
                    };

                    reader.onload = e => {
                        spark.append(e.target.result);
                        currentChunk++;
                        if (currentChunk < chunks) {
                            setTimeout(loadNext, 0); 
                        } else {
                            resolve(spark.end());
                        }
                    };
                    loadNext();
                });
            }

            async checkUpload(md5) {
                const res = await api('/api/files/upload/check', {
                    md5: md5,
                    file_size: this.file.size,
                    file_name: this.file.name,
                    parent_id: currentParentId
                });
                
                const data = res.data;
                if (data.status === 'instant') {
                    this.status = 'FINISHED';
                    this.progress = 100;
                    this.updateUI();
                    this.onComplete(this);
                    return { status: 'instant' };
                }
                return { status: data.status, offset: data.offset };
            }

            async uploadChunk(md5, offset, chunk) {
                const url = `${API_BASE}/api/files/upload/chunk?md5=${md5}&offset=${offset}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Token': token },
                    body: chunk,
                    signal: this.controller.signal
                });
                if (!response.ok) throw new Error('Upload failed');
            }

            async completeUpload(md5) {
                await api('/api/files/upload/complete', {
                    md5: md5,
                    file_name: this.file.name,
                    parent_id: currentParentId
                });
            }

            finish() {
                this.status = 'FINISHED';
                this.progress = 100;
                this.updateUI();
                this.onComplete(this);
            }

            updateUI() {
                const row = document.getElementById(`task-${this.fileSafeId}`);
                if (!row) return;

                const progressBar = row.querySelector('.progress-bar');
                const statusText = row.querySelector('.status-text');
                const btnAction = row.querySelector('.btn-action');

                progressBar.style.width = `${this.progress}%`;
                progressBar.innerText = this.progress < 10 ? '' : `${this.progress}%`;
                
                if (this.status === 'UPLOADING') {
                    statusText.innerText = 'ä¸Šä¼ ä¸­';
                    btnAction.innerText = 'æš‚åœ';
                    btnAction.onclick = () => this.pause();
                    btnAction.className = 'btn-action btn-pause';
                } else if (this.status === 'PAUSED') {
                    statusText.innerText = `æš‚åœ (${(this.offset/1024/1024).toFixed(1)}MB)`;
                    btnAction.innerText = 'ç»§ç»­';
                    btnAction.onclick = () => this.start();
                    btnAction.className = 'btn-action btn-resume';
                } else if (this.status === 'FINISHED') {
                    statusText.innerText = 'å®Œæˆ';
                    row.remove();
                   // btnAction.innerText = 'X';
                   // btnAction.className = 'btn-action btn-delete';
                    // btnAction.onclick = () => row.remove();
                } else if (this.status === 'ERROR') {
                    statusText.innerText = 'å¤±è´¥';
                    btnAction.innerText = 'é‡è¯•';
                    btnAction.onclick = () => this.start();
                    btnAction.className = 'btn-action btn-retry';
                }
            }
        }

        // ---------------------------------------------------------
        // åŸºç¡€ API åŠŸèƒ½
        // ---------------------------------------------------------
        
        const uploadTasks = [];

        if (token) {
            showMain();
            loadFiles();
        } else {
            document.getElementById('login-view').classList.remove('hidden');
        }

        async function api(url, data) {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) headers['Token'] = token;

            try {
                const res = await fetch(API_BASE + url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch (e) {
                console.error(e);
                return { code: -1, msg: e.message };
            }
        }

        function showMain() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        }

        async function doLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const res = await api('/api/user/login', { username: u, password: p });
            if (res.code === 0) {
                token = res.data.token;
                localStorage.setItem('token', token);
                showMain();
                loadFiles();
            } else {
                document.getElementById('login-msg').innerText = res.msg;
            }
        }

        async function doRegister() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const res = await api('/api/user/register', { username: u, password: p });
            alert(res.msg);
            if (res.code === 0) alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
        }

        async function doLogout() {
            localStorage.removeItem('token');
            location.reload();
        }

        async function loadFiles() {
            const res = await api('/api/files/list', { parent_id: currentParentId });
            const tbody = document.getElementById('file-tbody');
            tbody.innerHTML = '';
            
            if (res.code === 0) {
                res.data.forEach(f => {
                    const tr = document.createElement('tr');
                    const isFolder = f.file_type ===1;
                    
                    let sizeStr = f.file_size + ' B';
                    if(f.file_size > 1024*1024) sizeStr = (f.file_size/1024/1024).toFixed(2) + ' MB';
                    else if(f.file_size > 1024) sizeStr = (f.file_size/1024).toFixed(2) + ' KB';

                    tr.innerHTML = `
                        <td class="${isFolder ? 'folder' : ''}" 
                            title="ID: ${f.file_id}"
                            onclick="${isFolder ? `enterFolder(${f.file_id},'${f.file_name}')` : ''}">
                            ${isFolder ? '[DIR] ' : ''}${f.file_name}
                        </td>
                        <td>${sizeStr}</td>
                        <td>${isFolder ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'}</td>
                        <td>
                            ${!isFolder ? `<button onclick="downloadFile(${f.file_id}, '${f.file_name}')" class="op-btn" style="background-color: #4CAF50;">ä¸‹è½½</button>` : ''}
                            <button onclick="doRename(${f.file_id}, '${f.file_name}')" class="op-btn" style="background-color: #FF9800;">æ”¹å</button>
                            <button onclick="openMoveModal(${f.file_id})" class="op-btn" style="background-color: #2196F3;">ç§»åŠ¨</button>
                            <button onclick="doDelete(${f.file_id})" class="op-btn" style="background-color: #f44336;">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function enterFolder(id, name) {
            pathStack.push({id: id, name: name});
            currentParentId = id;
            updatePath();
            loadFiles();
        }

        function goBack() {
            if (pathStack.length > 1) {
                pathStack.pop();
                currentParentId = pathStack[pathStack.length-1].id;
                updatePath();
                loadFiles();
            }
        }

        function updatePath() {
            const path = pathStack.map(p => p.name).join(' / ');
            document.getElementById('current-path').innerText = path;
        }

        async function doMkdir() {
            const name = document.getElementById('new-folder-name').value;
            if (!name) return;
            const res = await api('/api/files/mkdir', { parent_id: currentParentId, folder_name: name });
            alert(res.msg);
            if (res.code === 0) {
                document.getElementById('new-folder-name').value = '';
                loadFiles();
            }
        }

        // ---------------------------------------------------------
        // æ–‡ä»¶æ“ä½œé€»è¾‘ (æ”¹å/ç§»åŠ¨/åˆ é™¤)
        // ---------------------------------------------------------

        async function doRename(fileId, oldName) {
            const newName = prompt("è¯·è¾“å…¥æ–°åç§°:", oldName);
            if (!newName || newName === oldName) return;

            const res = await api('/api/files/rename', { file_id: fileId, new_name: newName });
            alert(res.msg);
            if (res.code === 0) loadFiles();
        }

        async function doDelete(fileId) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿå¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œå¿…é¡»ä¸ºç©ºæ‰èƒ½åˆ é™¤ã€‚")) return;

            const res = await api('/api/files/delete', { file_id: fileId });
            alert(res.msg);
            if (res.code === 0) loadFiles();
        }

        async function downloadFile(id, name) {
            const headers = { 'Token': token, 'Content-Type': 'application/json' };
            const res = await fetch(API_BASE + '/api/files/download', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ file_id: id })
            });

            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                alert("ä¸‹è½½å¤±è´¥: " + res.statusText);
            }
        }

        // ---------------------------------------------------------
        // æ–‡ä»¶ç§»åŠ¨é€»è¾‘ (ä¸‹æ‹‰åˆ—è¡¨ç‰ˆ - æœ€ç»ˆä¿®å¤ç‰ˆ)
        // ---------------------------------------------------------

        async function openMoveModal(fileId) {
            fileToMoveId = fileId;
            // ã€å…³é”®ã€‘å…ˆç§»é™¤ hidden ç±»ï¼Œæ˜¾ç¤ºå¼¹çª—
            const modal = document.getElementById('move-modal');
            modal.classList.remove('hidden');

            // é‡ç½® Select å†…å®¹
            const select = document.getElementById('move-folder-select');
            select.innerHTML = '<option value="0" selected>ğŸ“‚ æ ¹ç›®å½•</option>';

            // å¼‚æ­¥åŠ è½½å…¶ä»–æ–‡ä»¶å¤¹
            try {
                const res = await api('/api/files/list', { fetch_all: 1 });
                if (res.code !== 0) {
                    alert('åŠ è½½ç›®å½•å¤±è´¥');
                    closeMoveModal();
                    return;
                }

                // éå†æ‰€æœ‰æ•°æ®ï¼Œåªæ·»åŠ æ–‡ä»¶å¤¹
                res.data.forEach(node => {
                    if (node.file_type === 1) {
                        const option = document.createElement('option');
                        option.value = node.file_id;
                        option.text = `ğŸ“ ${node.file_name} (ID:${node.file_id})`;
                        select.appendChild(option);
                    }
                });

            } catch (error) {
                console.error(error);
                alert('åŠ è½½å‡ºé”™ï¼Œè¯·ç¡®ä¿åç«¯å·²é‡å¯');
                closeMoveModal();
            }
        }

        function closeMoveModal() {
            // ã€å…³é”®ã€‘æ·»åŠ  hidden ç±»ï¼Œå¼ºåˆ¶éšè—
            document.getElementById('move-modal').classList.add('hidden');
            fileToMoveId = null;
        }

        async function confirmMove() {
            const select = document.getElementById('move-folder-select');
            const targetId = parseInt(select.value);

            if (!fileToMoveId) return;
            
            const res = await api('/api/files/move', { file_id: fileToMoveId, target_parent_id: targetId });
            alert(res.msg);
            
            // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½å…³é—­å¼¹çª—
            closeMoveModal();
            
            if (res.code === 0) {
                loadFiles();
            }
        }

        // ---------------------------------------------------------
        // å¤šæ–‡ä»¶ä¸Šä¼ é€»è¾‘
        // ---------------------------------------------------------

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const tbody = document.getElementById('upload-tbody');
            
            files.forEach(file => {
                const existingTask = uploadTasks.find(t => t.file.name === file.name && t.file.size === file.size);
                if (existingTask) return; 

                const tr = document.createElement('tr');
                tr.id = `task-${file.name.replace(/\W/g,'_')}`;
                tr.innerHTML = `
                    <td>${file.name}</td>
                    <td>${(file.size/1024/1024).toFixed(1)} MB</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 0%">0%</div>
                        </div>
                    </td>
                    <td class="status-text">ç­‰å¾…ä¸­</td>
                    <td><button class="btn-action">ç­‰å¾…</button></td>
                `;
                tbody.appendChild(tr);

                const task = new UploadTask(file, () => {
                    loadFiles();
                }, (errTask) => {
                });
                uploadTasks.push(task);

                task.start();
            });
            
            event.target.value = '';
        }
    </script>
</body>
</html>